<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Worker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700">
            <div class="p-6">
                <h1 class="text-xl font-semibold mb-6">Task Worker</h1>
                <nav class="space-y-1">
                    <a href="#" onclick="app.navigation.setView('overview')" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-view="overview">
                        <i class="fas fa-th-large mr-3 w-5"></i>
                        Overview
                    </a>
                    <a href="#" onclick="app.navigation.setView('projects')" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-view="projects">
                        <i class="fas fa-folder mr-3 w-5"></i>
                        Project Management
                    </a>
                    <a href="#" id="focus-nav" onclick="app.navigation.setView('focus')" class="nav-item hidden flex items-center px-4 py-3 text-sm font-medium rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-view="focus">
                        <i class="fas fa-crosshairs mr-3 w-5"></i>
                        Focus
                    </a>
                    <a href="#" onclick="app.navigation.setView('import-export')" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-view="import-export">
                        <i class="fas fa-file-import mr-3 w-5"></i>
                        Import/Export
                    </a>
                </nav>
            </div>
            
            <!-- Settings at bottom -->
            <div class="absolute bottom-0 w-64 p-6 border-t border-gray-200 dark:border-gray-700">
                <button onclick="app.toggleDarkMode()" class="flex items-center text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 transition-colors">
                    <i class="fas fa-moon dark:hidden mr-2"></i>
                    <i class="fas fa-sun hidden dark:inline mr-2"></i>
                    <span>Toggle theme</span>
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="flex-1 overflow-y-auto">
            <div id="main-content" class="p-8"></div>
        </div>
    </div>

    <script>
    // Utility Functions
    function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function downloadJSON(data, filename) {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Undo/Redo Manager
    class UndoRedoManager {
        constructor() {
            this.history = [];
            this.currentIndex = -1;
            this.isApplying = false;
        }

        add(state) {
            if (this.isApplying) return;
            this.history = this.history.slice(0, this.currentIndex + 1);
            this.history.push(state);
            this.currentIndex++;
            if (this.history.length > 50) {
                this.history.shift();
                this.currentIndex--;
            }
        }

        undo() {
            if (this.currentIndex > 0) {
                this.currentIndex--;
                this.isApplying = true;
                return this.history[this.currentIndex];
            }
            return null;
        }

        redo() {
            if (this.currentIndex < this.history.length - 1) {
                this.currentIndex++;
                this.isApplying = true;
                return this.history[this.currentIndex];
            }
            return null;
        }

        reset() {
            this.isApplying = false;
        }
    }

    // Data Models
    class Action {
        constructor(data = {}) {
            this.id = data.id || generateId();
            this.originalData = data.originalData || {};
            
            // New fields
            this.findingNumber = data.findingNumber || '';
            this.discipline = data.discipline || '';
            this.category = data.category || '';
            this.observationFinding = data.observationFinding || '';
            this.impact = data.impact || '';
            this.recommendation = data.recommendation || '';
            this.importance = data.importance || '';
            this.urgency = data.urgency || '';
            
            this.personalPriority = data.personalPriority || 0;
            this.assignee = data.assignee || 'Unassigned';
            this.originalAssignee = data.originalAssignee || data.assignee || 'Unassigned'; // Track original assignee
            this.progress = data.progress || 0;
            this.tags = data.tags || [];
            this.projectId = data.projectId || null;
            this.comment = data.comment || '';
            this.lastModified = data.lastModified || new Date().toISOString();
            this.createdAt = data.createdAt || new Date().toISOString();
            this.deadline = data.deadline || null;
            this.excelRowData = data.excelRowData || [];
            this.taskList = data.taskList || [];
        }

        toJSON() {
            return {
                id: this.id,
                originalData: this.originalData,
                findingNumber: this.findingNumber,
                discipline: this.discipline,
                category: this.category,
                observationFinding: this.observationFinding,
                impact: this.impact,
                recommendation: this.recommendation,
                importance: this.importance,
                urgency: this.urgency,
                personalPriority: this.personalPriority,
                assignee: this.assignee,
                originalAssignee: this.originalAssignee,
                progress: this.progress,
                tags: this.tags,
                projectId: this.projectId,
                comment: this.comment,
                lastModified: this.lastModified,
                createdAt: this.createdAt,
                deadline: this.deadline,
                excelRowData: this.excelRowData,
                taskList: this.taskList
            };
        }

        static fromJSON(json) {
            return new Action(json);
        }

        getPriorityColor() {
            // Determine color based on importance and urgency combination
            const importance = (this.importance || 'M').toUpperCase().trim();
            const urgency = (this.urgency || 'M').toUpperCase().trim();
            
            if (importance === 'H' && urgency === 'H') return '#DC2626'; // red-600
            if (importance === 'H' || urgency === 'H') return '#F59E0B'; // amber-500
            if (importance === 'L' && urgency === 'L') return '#10B981'; // emerald-500
            if (importance === 'M' && urgency === 'M') return '#6B7280'; // gray-500
            return '#6B7280'; // gray-500 for any other case
        }

        getPriorityLevel() {
            const importance = this.importance?.toUpperCase() || 'M';
            const urgency = this.urgency?.toUpperCase() || 'M';
            
            if (importance === 'H' && urgency === 'H') return 'critical';
            if (importance === 'H' || urgency === 'H') return 'high';
            if (importance === 'L' && urgency === 'L') return 'low';
            return 'medium';
        }

        getPriorityWeight() {
            const level = this.getPriorityLevel();
            if (level === 'critical') return 4;
            if (level === 'high') return 3;
            if (level === 'medium') return 2;
            if (level === 'low') return 1;
            return 0;
        }

        getStatus() {
            if (this.progress === 0) return 'Not Started';
            if (this.progress === 100) return 'Completed';
            return 'In Progress';
        }

        getAllComments() {
            return this.comment || '';
        }

        getDisplayTitle() {
            let title = '';
            if (this.findingNumber) title += `${this.findingNumber}: `;
            if (this.discipline) title += this.discipline;
            if (this.discipline && this.category) title += ' - ';
            if (this.category) title += this.category;
            return title || 'Untitled Action';
        }

        getCardTitle() {
            const title = this.getDisplayTitle();
            return title.length > 50 ? title.substring(0, 50) + '...' : title;
        }

        getCardDescription() {
            return this.observationFinding || 'No observation/finding available';
        }
    }

    class Project {
        constructor(data = {}) {
            this.id = data.id || generateId();
            this.name = data.name || 'New Project';
            this.createdAt = data.createdAt || new Date().toISOString();
            this.columnMapping = data.columnMapping || {
                findingNumber: null,
                discipline: null,
                category: null,
                observationFinding: null,
                impact: null,
                recommendation: null,
                importance: null,
                urgency: null,
                assignee: null
            };
            this.excelHeaders = data.excelHeaders || [];
            this.tempExcelData = data.tempExcelData || [];
            this.customColumns = data.customColumns || [];
        }

        toJSON() {
            return {
                id: this.id,
                name: this.name,
                createdAt: this.createdAt,
                columnMapping: this.columnMapping,
                excelHeaders: this.excelHeaders,
                tempExcelData: this.tempExcelData,
                customColumns: this.customColumns
            };
        }

        static fromJSON(json) {
            return new Project(json);
        }
    }

    // StateManager
    class StateManager {
        constructor() {
            this.state = {
                actions: new Map(),
                projects: new Map(),
                selectedProjectId: null,
                currentView: 'overview',
                focusActionId: null,
                editingAssigneeId: null,
                filters: {
                    search: '',
                    projectIds: new Set(),
                    assignees: new Set(),
                    priorities: new Set(),
                    progress: 'all',
                    hasRating: false,
                    priorityLevels: new Set()
                },
                replaceMode: false,
                darkMode: localStorage.getItem('darkMode') === 'true',
                tableEditMode: false,
                activeCell: { row: null, col: null },
                expandedCards: new Set(),
                sortOrder: 'originalPriority',
                controlsPanelExpanded: false,
                filterSectionExpanded: false,
                previousFilterState: null
            };
            this.debouncedPersist = debounce(() => this.persist(), 500);
            this.undoRedoManager = new UndoRedoManager();
        }

        init() {
            this.restore();
            if (this.state.darkMode) {
                document.documentElement.classList.add('dark');
            }
            this.updateFocusNavVisibility();
        }

        updateFocusNavVisibility() {
            const focusNav = document.getElementById('focus-nav');
            if (focusNav) {
                if (this.state.focusActionId) {
                    focusNav.classList.remove('hidden');
                } else {
                    focusNav.classList.add('hidden');
                }
            }
        }

        toggleDarkMode() {
            this.state.darkMode = !this.state.darkMode;
            if (this.state.darkMode) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            localStorage.setItem('darkMode', this.state.darkMode);
        }

        addProject(project) {
            this.state.projects.set(project.id, project);
            this.debouncedPersist();
        }

        updateProject(id, updates) {
            const project = this.state.projects.get(id);
            if (!project) return;
            Object.assign(project, updates);
            this.debouncedPersist();
        }

        deleteProject(id) {
            for (const [actionId, action] of this.state.actions) {
                if (action.projectId === id) {
                    this.state.actions.delete(actionId);
                }
            }
            
            this.state.projects.delete(id);
            this.state.filters.projectIds.delete(id);
            
            if (this.state.selectedProjectId === id) {
                this.state.selectedProjectId = null;
            }
            
            this.debouncedPersist();
        }

        selectProject(projectId) {
            this.state.selectedProjectId = projectId;
            this.debouncedPersist();
        }

        setFocusAction(actionId) {
            this.state.focusActionId = actionId;
            this.updateFocusNavVisibility();
            this.debouncedPersist();
        }

        addAction(action) {
            this.state.actions.set(action.id, action);
            this.debouncedPersist();
        }

        updateAction(id, updates) {
            const action = this.state.actions.get(id);
            if (!action) return;
            
            Object.assign(action, updates);
            action.lastModified = new Date().toISOString();
            this.state.actions.set(id, action);
            this.debouncedPersist();
        }

        deleteAction(id) {
            this.state.actions.delete(id);
            if (this.state.focusActionId === id) {
                this.state.focusActionId = null;
                this.updateFocusNavVisibility();
            }
            this.debouncedPersist();
        }

        toggleCardExpansion(actionId) {
            if (this.state.expandedCards.has(actionId)) {
                this.state.expandedCards.delete(actionId);
            } else {
                this.state.expandedCards.add(actionId);
            }
            this.debouncedPersist();
        }

        setSortOrder(order) {
            this.state.sortOrder = order;
            this.debouncedPersist();
        }

        toggleControlsPanel() {
            this.state.controlsPanelExpanded = !this.state.controlsPanelExpanded;
            this.debouncedPersist();
        }

        toggleFilterSection() {
            this.state.filterSectionExpanded = !this.state.filterSectionExpanded;
            this.debouncedPersist();
        }

        toggleProjectFilter(projectId) {
            if (this.state.filters.projectIds.has(projectId)) {
                this.state.filters.projectIds.delete(projectId);
            } else {
                this.state.filters.projectIds.add(projectId);
            }
            this.debouncedPersist();
        }

        toggleAssigneeFilter(assignee) {
            if (this.state.filters.assignees.has(assignee)) {
                this.state.filters.assignees.delete(assignee);
            } else {
                this.state.filters.assignees.add(assignee);
            }
            this.debouncedPersist();
        }

        toggleProgressFilter(action) {
            // Check if we're already filtering by the same criteria
            if (action.progress === 100 && this.state.filters.progress === 'completed') {
                // Reset to default
                this.state.filters.progress = 'all';
                this.state.sortOrder = 'originalPriority';
            } else if (action.progress > 0 && action.progress < 100 && 
                       this.state.filters.progress === 'in-progress' && 
                       this.state.sortOrder === 'progress') {
                // Reset to default
                this.state.filters.progress = 'all';
                this.state.sortOrder = 'originalPriority';
            } else {
                // Apply new filter
                if (action.progress === 100) {
                    this.state.filters.progress = 'completed';
                } else if (action.progress > 0) {
                    this.state.filters.progress = 'in-progress';
                    this.state.sortOrder = 'progress';
                }
            }
            this.debouncedPersist();
        }

        toggleRatingFilter() {
            if (this.state.filters.hasRating && this.state.sortOrder === 'priority') {
                // Reset to default
                this.state.filters.hasRating = false;
                this.state.sortOrder = 'originalPriority';
            } else {
                // Apply rating filter and sort
                this.state.filters.hasRating = true;
                this.state.sortOrder = 'priority';
            }
            this.debouncedPersist();
        }

        togglePriorityLevelFilter(priorityLevel) {
            if (this.state.filters.priorityLevels.has(priorityLevel)) {
                this.state.filters.priorityLevels.delete(priorityLevel);
            } else {
                this.state.filters.priorityLevels.add(priorityLevel);
            }
            this.debouncedPersist();
        }

        getUniqueAssignees() {
            const assignees = new Set();
            this.state.actions.forEach(action => {
                assignees.add(action.assignee);
            });
            return Array.from(assignees).sort();
        }

        getProjectAssignees(projectId) {
            const assignees = new Set();
            this.state.actions.forEach(action => {
                if (action.projectId === projectId) {
                    if (action.assignee && action.assignee !== 'Unassigned') {
                        assignees.add(action.assignee);
                    }
                    if (action.originalAssignee && action.originalAssignee !== 'Unassigned') {
                        assignees.add(action.originalAssignee);
                    }
                }
            });
            return Array.from(assignees).sort();
        }

        getFilteredActions() {
            let actions = Array.from(this.state.actions.values());
            
            if (this.state.filters.projectIds.size > 0) {
                actions = actions.filter(action => 
                    this.state.filters.projectIds.has(action.projectId)
                );
            }
            
            if (this.state.filters.search) {
                const search = this.state.filters.search.toLowerCase();
                actions = actions.filter(action => {
                    const searchable = `${action.getDisplayTitle()} ${action.getCardDescription()} ${action.assignee}`.toLowerCase();
                    return searchable.includes(search);
                });
            }
            
            if (this.state.filters.assignees.size > 0) {
                actions = actions.filter(action => 
                    this.state.filters.assignees.has(action.assignee)
                );
            }
            
            if (this.state.filters.progress !== 'all') {
                actions = actions.filter(action => {
                    if (this.state.filters.progress === 'not-started') return action.progress === 0;
                    if (this.state.filters.progress === 'in-progress') return action.progress > 0 && action.progress < 100;
                    if (this.state.filters.progress === 'completed') return action.progress === 100;
                    return true;
                });
            }
            
            if (this.state.filters.hasRating) {
                actions = actions.filter(action => action.personalPriority > 0);
            }
            
            if (this.state.filters.priorityLevels.size > 0) {
                actions = actions.filter(action => 
                    this.state.filters.priorityLevels.has(action.getPriorityLevel())
                );
            }
            
            actions.sort((a, b) => {
                switch(this.state.sortOrder) {
                    case 'lastModified':
                        return new Date(b.lastModified) - new Date(a.lastModified);
                    case 'alphabetical':
                        return a.getDisplayTitle().localeCompare(b.getDisplayTitle());
                    case 'createdAt':
                        return new Date(a.createdAt) - new Date(b.createdAt);
                    case 'priority':
                        const aPri = a.personalPriority || 0;
                        const bPri = b.personalPriority || 0;
                        if (bPri === aPri) {
                            return new Date(b.lastModified) - new Date(a.lastModified);
                        }
                        return bPri - aPri;
                    case 'originalPriority':
                        const aWeight = a.getPriorityWeight();
                        const bWeight = b.getPriorityWeight();
                        if (aWeight === bWeight) {
                            return new Date(b.lastModified) - new Date(a.lastModified);
                        }
                        return bWeight - aWeight;
                    case 'progress':
                        if (b.progress === a.progress) {
                            return new Date(b.lastModified) - new Date(a.lastModified);
                        }
                        return b.progress - a.progress;
                    default:
                        return 0;
                }
            });
            
            return actions;
        }

        getProjectActions(projectId) {
            return Array.from(this.state.actions.values())
                .filter(action => action.projectId === projectId);
        }

        saveTableState() {
            const actions = this.getProjectActions(this.state.selectedProjectId);
            const tableState = actions.map(action => ({
                id: action.id,
                excelRowData: [...action.excelRowData]
            }));
            this.undoRedoManager.add(tableState);
        }

        applyTableState(tableState) {
            tableState.forEach(state => {
                const action = this.state.actions.get(state.id);
                if (action) {
                    action.excelRowData = [...state.excelRowData];
                    this.updateAction(state.id, action);
                }
            });
        }

        persist() {
            const data = {
                version: '3.0',
                lastSaved: new Date().toISOString(),
                state: {
                    actions: Array.from(this.state.actions.entries()).map(([id, action]) => action.toJSON()),
                    projects: Array.from(this.state.projects.entries()).map(([id, project]) => project.toJSON()),
                    selectedProjectId: this.state.selectedProjectId,
                    focusActionId: this.state.focusActionId,
                    sortOrder: this.state.sortOrder,
                    currentView: this.state.currentView,
                    controlsPanelExpanded: this.state.controlsPanelExpanded,
                    filterSectionExpanded: this.state.filterSectionExpanded,
                    expandedCards: Array.from(this.state.expandedCards),
                    filters: {
                        search: this.state.filters.search,
                        projectIds: Array.from(this.state.filters.projectIds),
                        assignees: Array.from(this.state.filters.assignees),
                        priorities: Array.from(this.state.filters.priorities),
                        progress: this.state.filters.progress,
                        hasRating: this.state.filters.hasRating,
                        priorityLevels: Array.from(this.state.filters.priorityLevels)
                    }
                }
            };
            localStorage.setItem('actionTracker', JSON.stringify(data));
        }

        restore() {
            try {
                const stored = localStorage.getItem('actionTracker');
                if (!stored) return;
                
                const data = JSON.parse(stored);
                
                if (data.state.projects) {
                    data.state.projects.forEach(projectData => {
                        const project = Project.fromJSON(projectData);
                        this.state.projects.set(project.id, project);
                    });
                }
                
                if (data.state.actions) {
                    data.state.actions.forEach(actionData => {
                        const action = Action.fromJSON(actionData);
                        this.state.actions.set(action.id, action);
                    });
                }
                
                if (data.state.selectedProjectId && this.state.projects.has(data.state.selectedProjectId)) {
                    this.state.selectedProjectId = data.state.selectedProjectId;
                }
                
                if (data.state.focusActionId && this.state.actions.has(data.state.focusActionId)) {
                    this.state.focusActionId = data.state.focusActionId;
                }
                
                if (data.state.sortOrder) {
                    this.state.sortOrder = data.state.sortOrder;
                } else {
                    // Set default to originalPriority for existing data
                    this.state.sortOrder = 'originalPriority';
                }
                
                if (data.state.currentView) {
                    this.state.currentView = data.state.currentView;
                }
                
                if (data.state.controlsPanelExpanded !== undefined) {
                    this.state.controlsPanelExpanded = data.state.controlsPanelExpanded;
                }
                
                if (data.state.filterSectionExpanded !== undefined) {
                    this.state.filterSectionExpanded = data.state.filterSectionExpanded;
                }
                
                if (data.state.expandedCards) {
                    this.state.expandedCards = new Set(data.state.expandedCards);
                }
                
                if (data.state.filters) {
                    if (data.state.filters.search !== undefined) {
                        this.state.filters.search = data.state.filters.search;
                    }
                    if (data.state.filters.projectIds) {
                        data.state.filters.projectIds.forEach(id => {
                            if (this.state.projects.has(id)) {
                                this.state.filters.projectIds.add(id);
                            }
                        });
                    }
                    if (data.state.filters.assignees) {
                        this.state.filters.assignees = new Set(data.state.filters.assignees);
                    }
                    if (data.state.filters.priorities) {
                        this.state.filters.priorities = new Set(data.state.filters.priorities);
                    }
                    if (data.state.filters.progress) {
                        this.state.filters.progress = data.state.filters.progress;
                    }
                    if (data.state.filters.hasRating !== undefined) {
                        this.state.filters.hasRating = data.state.filters.hasRating;
                    }
                    if (data.state.filters.priorityLevels) {
                        this.state.filters.priorityLevels = new Set(data.state.filters.priorityLevels);
                    }
                }
            } catch (error) {
                console.error('Failed to restore state:', error);
            }
        }

        exportDatabase(projectIds) {
            const exportData = {
                version: '3.0',
                exportDate: new Date().toISOString(),
                projects: [],
                actions: []
            };
            
            projectIds.forEach(projectId => {
                const project = this.state.projects.get(projectId);
                if (project) {
                    exportData.projects.push(project.toJSON());
                    
                    const actions = this.getProjectActions(projectId);
                    actions.forEach(action => {
                        exportData.actions.push(action.toJSON());
                    });
                }
            });
            
            return exportData;
        }

        importDatabase(data) {
            data.projects.forEach(projectData => {
                const project = Project.fromJSON(projectData);
                project.id = generateId();
                this.state.projects.set(project.id, project);
                
                const oldProjectId = projectData.id;
                data.actions.filter(a => a.projectId === oldProjectId).forEach(actionData => {
                    const action = Action.fromJSON(actionData);
                    action.id = generateId();
                    action.projectId = project.id;
                    this.state.actions.set(action.id, action);
                });
            });
            
            this.debouncedPersist();
        }
    }

    // Navigation Manager
    class NavigationManager {
        constructor(stateManager, renderManager) {
            this.stateManager = stateManager;
            this.renderManager = renderManager;
        }

        setView(view) {
            this.stateManager.state.currentView = view;
            this.updateNavHighlight(view);
            this.stateManager.debouncedPersist();
            this.renderManager.render();
        }

        updateNavHighlight(view) {
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.dataset.view === view) {
                    item.classList.add('bg-gray-100', 'dark:bg-gray-700');
                } else {
                    item.classList.remove('bg-gray-100', 'dark:bg-gray-700');
                }
            });
        }
    }

    // Filter Manager
    class FilterManager {
        constructor(stateManager, renderManager) {
            this.stateManager = stateManager;
            this.renderManager = renderManager;
        }

        updateFilter(type, value) {
            this.stateManager.state.filters[type] = value;
            this.stateManager.debouncedPersist();
            this.renderManager.render();
        }

        toggleProjectFilter(projectId) {
            this.stateManager.toggleProjectFilter(projectId);
            this.renderManager.render();
        }

        toggleAssigneeFilter(assignee) {
            this.stateManager.toggleAssigneeFilter(assignee);
            this.renderManager.render();
        }

        setSortOrder(order) {
            this.stateManager.setSortOrder(order);
            this.renderManager.render();
        }

        toggleControlsPanel() {
            this.stateManager.toggleControlsPanel();
            this.renderManager.render();
        }

        toggleFilterSection() {
            this.stateManager.toggleFilterSection();
            this.renderManager.render();
        }

        renderControlsPanel(actions, projects, assignees) {
            const isExpanded = this.stateManager.state.controlsPanelExpanded;
            const isFilterExpanded = this.stateManager.state.filterSectionExpanded;
            
            return `
                <div class="fixed bottom-5 right-5 z-50">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden transition-all duration-300 border border-gray-200 dark:border-gray-700 ${
                        isExpanded ? 'w-80 opacity-100 transform scale-100' : 'w-0 h-0 opacity-0 transform scale-95'
                    }">
                        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <div class="text-2xl font-bold text-blue-600">${actions.length}</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">actions</div>
                                </div>
                                <button onclick="app.filter.toggleControlsPanel()" 
                                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                                        aria-label="Close controls panel">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <label for="search-input" class="sr-only">Search actions</label>
                            <input type="text" 
                                   id="search-input"
                                   name="search"
                                   placeholder="Search actions..." 
                                   value="${this.stateManager.state.filters.search}"
                                   oninput="app.filter.updateFilter('search', this.value)"
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 mb-3">
                            
                            <label for="sort-select" class="sr-only">Sort order</label>
                            <select id="sort-select"
                                    name="sort"
                                    onchange="app.filter.setSortOrder(this.value)" 
                                    value="${this.stateManager.state.sortOrder}"
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 mb-3">
                                <option value="originalPriority" ${this.stateManager.state.sortOrder === 'originalPriority' ? 'selected' : ''}>Priority (High to Low)</option>
                                <option value="lastModified" ${this.stateManager.state.sortOrder === 'lastModified' ? 'selected' : ''}>Last Modified</option>
                                <option value="alphabetical" ${this.stateManager.state.sortOrder === 'alphabetical' ? 'selected' : ''}>Alphabetical</option>
                                <option value="createdAt" ${this.stateManager.state.sortOrder === 'createdAt' ? 'selected' : ''}>Entry Order</option>
                                <option value="priority" ${this.stateManager.state.sortOrder === 'priority' ? 'selected' : ''}>Star Priority</option>
                                <option value="progress" ${this.stateManager.state.sortOrder === 'progress' ? 'selected' : ''}>Progress Order</option>
                            </select>
                            
                            <button onclick="app.filter.toggleFilterSection()" 
                                    class="w-full px-3 py-2 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-colors"
                                    aria-expanded="${isFilterExpanded}"
                                    aria-controls="filter-section">
                                <i class="fas fa-filter mr-2"></i>Filters ${isFilterExpanded ? '▲' : '▼'}
                            </button>
                        </div>
                        
                        <div id="filter-section" class="transition-all duration-300 ${isFilterExpanded ? 'max-h-96' : 'max-h-0'} overflow-hidden">
                            <div class="p-4 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Projects</label>
                                    <fieldset>
                                        <legend class="sr-only">Select projects to filter</legend>
                                        <div class="space-y-2 max-h-32 overflow-y-auto">
                                            ${projects.map(project => `
                                                <label class="flex items-center">
                                                    <input type="checkbox" 
                                                           id="project-filter-${project.id}"
                                                           name="project-filter"
                                                           value="${project.id}"
                                                           ${this.stateManager.state.filters.projectIds.has(project.id) ? 'checked' : ''}
                                                           onchange="app.filter.toggleProjectFilter('${project.id}')"
                                                           class="mr-2">
                                                    <span class="text-sm">${project.name}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </fieldset>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium mb-2">Assignees</label>
                                    <fieldset>
                                        <legend class="sr-only">Select assignees to filter</legend>
                                        <div class="space-y-2 max-h-32 overflow-y-auto">
                                            ${assignees.map(assignee => `
                                                <label class="flex items-center">
                                                    <input type="checkbox" 
                                                           id="assignee-filter-${assignee.replace(/\s+/g, '-')}"
                                                           name="assignee-filter"
                                                           value="${assignee}"
                                                           ${this.stateManager.state.filters.assignees.has(assignee) ? 'checked' : ''}
                                                           onchange="app.filter.toggleAssigneeFilter('${assignee}')"
                                                           class="mr-2">
                                                    <span class="text-sm">${assignee}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </fieldset>
                                </div>
                                
                                <div>
                                    <label for="progress-filter" class="block text-sm font-medium mb-2">Progress</label>
                                    <select id="progress-filter"
                                            name="progress-filter"
                                            onchange="app.filter.updateFilter('progress', this.value)" 
                                            value="${this.stateManager.state.filters.progress}"
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                                        <option value="all" ${this.stateManager.state.filters.progress === 'all' ? 'selected' : ''}>All</option>
                                        <option value="not-started" ${this.stateManager.state.filters.progress === 'not-started' ? 'selected' : ''}>Not Started</option>
                                        <option value="in-progress" ${this.stateManager.state.filters.progress === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="completed" ${this.stateManager.state.filters.progress === 'completed' ? 'selected' : ''}>Completed</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="flex items-center">
                                        <input type="checkbox" 
                                               id="rating-filter"
                                               name="rating-filter"
                                               ${this.stateManager.state.filters.hasRating ? 'checked' : ''}
                                               onchange="app.clickStarFilter()"
                                               class="mr-2">
                                        <span class="text-sm">Show only rated actions</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="app.filter.toggleControlsPanel()" 
                            class="w-14 h-14 bg-gray-600 dark:bg-gray-700 text-white rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 border border-gray-500 dark:border-gray-600 ${
                                isExpanded ? 'hidden' : 'flex'
                            } items-center justify-center"
                            aria-label="Open controls panel">
                        <i class="fas fa-sliders-h text-xl"></i>
                    </button>
                </div>
            `;
        }
    }

    // Overview Renderer
    class OverviewRenderer {
        constructor(stateManager, filterManager) {
            this.stateManager = stateManager;
            this.filterManager = filterManager;
        }

        render(container) {
            const actions = this.stateManager.getFilteredActions();
            const projects = Array.from(this.stateManager.state.projects.values());
            const assignees = this.stateManager.getUniqueAssignees();
            
            container.innerHTML = `
                <div class="mb-8">
                    <h2 class="text-2xl font-bold mb-2">Overview</h2>
                    <p class="text-gray-600 dark:text-gray-400">Track and manage all your actions across projects</p>
                </div>
                
                ${projects.length === 0 ? this.renderEmptyState() : this.renderActionGrid(actions, projects, assignees)}
            `;
        }

        renderEmptyState() {
            return `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-12 text-center border border-gray-200 dark:border-gray-700">
                    <i class="fas fa-folder-plus text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2">No Projects Yet</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">Create your first project to start tracking actions</p>
                    <button onclick="app.navigation.setView('projects')" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-900 dark:text-gray-100 rounded-lg transition-colors border border-gray-300 dark:border-gray-600">
                        <i class="fas fa-plus mr-2"></i>Create Project
                    </button>
                </div>
            `;
        }

        renderActionGrid(actions, projects, assignees) {
            return `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20">
                    ${actions.map(action => this.renderActionCard(action)).join('')}
                    ${actions.length === 0 ? `
                        <div class="col-span-full text-center py-12 text-gray-500 dark:text-gray-400">
                            <i class="fas fa-inbox text-4xl mb-4"></i>
                            <p>No actions found</p>
                            <p class="text-sm">Import data in Project Management to add actions</p>
                        </div>
                    ` : ''}
                </div>
                
                ${this.filterManager.renderControlsPanel(actions, projects, assignees)}
            `;
        }

        renderActionCard(action) {
            const project = this.stateManager.state.projects.get(action.projectId);
            const priorityColor = action.getPriorityColor();
            const priorityLevel = action.getPriorityLevel();
            const isExpanded = this.stateManager.state.expandedCards.has(action.id);
            const description = action.getCardDescription();
            const hasStarRating = action.personalPriority > 0;
            const isUrgent = (action.urgency || '').toUpperCase().trim() === 'H';
            const isCompleted = action.progress === 100;
            
            // Add buffer logic for clipping
            const CLIP_LENGTH = 150;
            const BUFFER = 10;
            const shouldClip = description.length > (CLIP_LENGTH + BUFFER);
            const displayDescription = shouldClip && !isExpanded ? 
                description.substring(0, CLIP_LENGTH) + '...' : 
                description;
            
            return `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm hover:shadow-md transition-shadow p-6 relative flex flex-col h-full border border-gray-200 dark:border-gray-700">
                    ${hasStarRating ? `
                        <div class="absolute top-2 left-2 w-10 h-10 drop-shadow-lg cursor-pointer z-10" onclick="event.stopPropagation(); app.clickStarFilter()">
                            <svg class="w-full h-full" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <radialGradient id="starGradient-${action.id}" cx="50%" cy="40%" r="60%">
                                        <stop offset="0%" style="stop-color:#facc15;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#ca8a04;stop-opacity:1" />
                                    </radialGradient>
                                </defs>
                                <path 
                                    d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" 
                                    stroke="#facc15"
                                    stroke-width="2"
                                    fill="url(#starGradient-${action.id})"
                                />
                                <text 
                                    x="12" 
                                    y="16" 
                                    text-anchor="middle" 
                                    font-size="12" 
                                    font-weight="bold" 
                                    fill="#ffffff"
                                    style="text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;"
                                >
                                    ${action.personalPriority}
                                </text>
                            </svg>
                        </div>
                    ` : ''}
                    
                    <span class="absolute top-4 right-4 text-xs text-gray-400 dark:text-gray-500 cursor-pointer hover:text-blue-600 dark:hover:text-blue-400 transition-colors z-10"
                        onclick="event.stopPropagation(); app.filter.toggleProjectFilter('${action.projectId}')">
                        ${project ? project.name : ''}
                    </span>
                    
                    <h3 class="text-lg font-semibold mb-3 cursor-pointer hover:text-blue-600 dark:hover:text-blue-400 transition-colors w-full ${hasStarRating ? 'mt-8' : ''}"
                        onclick="event.stopPropagation(); app.selectActionForFocus('${action.id}')">
                        ${action.getCardTitle()}
                    </h3>
                    <div class="w-32 h-1 mb-3 cursor-pointer" 
                        style="background-color: ${priorityColor}"
                        onclick="event.stopPropagation(); app.clickPriorityFilter('${priorityLevel}')"></div>
                    
                    <div class="cursor-pointer flex-grow" onclick="event.stopPropagation(); app.toggleCardExpansion('${action.id}')">
                        <p class="text-gray-700 dark:text-gray-300 mb-4 ${isExpanded ? '' : 'line-clamp-3 overflow-hidden'}">
                            ${displayDescription}
                        </p>
                        ${!isExpanded && shouldClip ? `
                            <span class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 transition-colors">
                                Read more...
                            </span>
                        ` : ''}
                    </div>
                    
                    <div class="mt-auto pt-4">
                        <div class="flex items-center justify-between mb-2">
                            ${isUrgent && !isCompleted ? `
                                <span class="text-sm font-semibold text-red-600 dark:text-red-400 flex items-center gap-1">
                                    <i class="fas fa-exclamation-circle"></i>
                                    Urgent!
                                </span>
                            ` : '<span></span>'}
                            <span class="text-sm text-gray-500 dark:text-gray-400 cursor-pointer hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
                                onclick="event.stopPropagation(); app.filter.toggleAssigneeFilter('${action.assignee}')">
                                ${action.assignee}
                            </span>
                        </div>
                        
                        ${action.progress > 0 ? `
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden cursor-pointer"
                                onclick="event.stopPropagation(); app.clickProgressBar('${action.id}')">
                                <div class="${action.progress === 100 ? 'bg-green-500 dark:bg-green-400 shadow-lg shadow-green-500/50' : 'bg-blue-500 dark:bg-yellow-400'} h-2 rounded-full transition-all duration-300" 
                                    style="width: ${action.progress}%"></div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
    }

    // Project Renderer
    class ProjectRenderer {
        constructor(stateManager) {
            this.stateManager = stateManager;
            this.editingProjectId = null;
        }

        render(container) {
            const projects = Array.from(this.stateManager.state.projects.values());
            const selectedProject = this.stateManager.state.projects.get(this.stateManager.state.selectedProjectId);
            
            container.innerHTML = `
                <div class="mb-8">
                    <h2 class="text-2xl font-bold mb-2">Project Management</h2>
                    <p class="text-gray-600 dark:text-gray-400">Create projects and import Excel data</p>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6 border border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold">Projects</h3>
                        <button onclick="app.project.createNewProject()" 
                                class="px-4 py-2 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-900 dark:text-gray-100 rounded-lg transition-colors border border-gray-300 dark:border-gray-600">
                            <i class="fas fa-plus mr-2"></i>New Project
                        </button>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                        ${projects.map(project => this.renderProjectItem(project)).join('')}
                        ${projects.length === 0 ? `
                            <p class="text-sm text-gray-500 dark:text-gray-400 col-span-full text-center py-8">
                                No projects yet. Click "New Project" to create one.
                            </p>
                        ` : ''}
                    </div>
                </div>
                
                ${selectedProject ? this.renderProjectImportArea(selectedProject) : ''}
            `;
        }

        renderProjectItem(project) {
            const isSelected = this.stateManager.state.selectedProjectId === project.id;
            const actionCount = this.stateManager.getProjectActions(project.id).length;
            
            if (this.editingProjectId === project.id) {
                return `
                    <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-300 dark:border-gray-600">
                        <input type="text" id="edit-project-${project.id}" value="${project.name}" 
                            class="w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800"
                            onkeypress="if(event.key === 'Enter') app.project.saveProjectName('${project.id}')">
                        <div class="flex gap-2 mt-2">
                            <button onclick="app.project.saveProjectName('${project.id}')" class="flex-1 px-2 py-1 text-sm bg-green-600 hover:bg-green-700 text-white rounded transition-colors">
                                <i class="fas fa-check"></i>
                            </button>
                            <button onclick="app.project.cancelProjectEdit()" class="flex-1 px-2 py-1 text-sm bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 rounded transition-colors">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="group p-4 rounded-lg cursor-pointer transition-all flex items-center justify-between border relative ${isSelected ? 'bg-gray-200 dark:bg-gray-700 border-gray-400 dark:border-gray-500' : 'bg-gray-50 dark:bg-gray-900 hover:bg-gray-100 dark:hover:bg-gray-800 border-gray-300 dark:border-gray-600'}"
                    onclick="app.project.selectProject('${project.id}')">
                    <div class="flex items-center gap-3">
                        <span class="font-medium">${project.name}</span>
                        <span class="text-sm ${isSelected ? 'text-gray-700 dark:text-gray-300' : 'text-gray-500 dark:text-gray-400'}">${actionCount}</span>
                    </div>
                    <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity absolute right-2">
                        <button onclick="event.stopPropagation(); app.project.editProjectName('${project.id}')" 
                                class="p-1 text-xs ${isSelected ? 'bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500' : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600'} rounded transition-colors">
                            <i class="fas fa-pen"></i>
                        </button>
                        <button onclick="event.stopPropagation(); app.project.confirmDeleteProject('${project.id}')" 
                                class="p-1 text-xs ${isSelected ? 'bg-red-500 hover:bg-red-600 text-white' : 'bg-gray-200 dark:bg-gray-700 hover:bg-red-500 hover:text-white'} rounded transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        renderProjectImportArea(project) {
            const hasExcelData = project.tempExcelData && project.tempExcelData.length > 0;
            const hasImportedActions = this.stateManager.getProjectActions(project.id).length > 0;
            
            if (hasImportedActions && project.excelHeaders.length > 0) {
                return app.tableEditor.renderProjectDataTable(project);
            }
            
            return `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold mb-4">Import Excel Data - ${project.name}</h3>
                    
                    <div class="mb-4">
                        <label class="flex items-center mb-4">
                            <input type="checkbox" 
                                   id="replace-mode"
                                   name="replace-mode"
                                   ${this.stateManager.state.replaceMode ? 'checked' : ''} 
                                   onchange="app.stateManager.state.replaceMode = this.checked"
                                   class="mr-2">
                            <span class="text-sm">Replace existing actions in project</span>
                        </label>
                        
                        <label for="excel-paste" class="block text-sm font-medium mb-2">Paste Excel Data</label>
                        <textarea id="excel-paste" 
                                  name="excel-paste"
                                  class="w-full h-32 p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700" 
                                  placeholder="Copy data from Excel and paste here..."
                                  aria-describedby="excel-paste-help"></textarea>
                        <p id="excel-paste-help" class="sr-only">Copy data from Excel including headers and paste it here</p>
                        
                        <button onclick="app.project.processExcelImport()" 
                                class="mt-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                            <i class="fas fa-paste mr-2"></i>Process Data
                        </button>
                    </div>
                    
                    ${hasExcelData ? this.renderExcelPreview(project) : ''}
                </div>
            `;
        }

        renderExcelPreview(project) {
            const headers = project.excelHeaders;
            const data = project.tempExcelData;
            
            // Function to match column names
            const matchColumn = (header) => {
                const normalized = header.toLowerCase().trim();
                
                // Define mapping rules for each column type
                const mappingRules = {
                    findingNumber: ['finding #', 'finding number', 'finding no', 'finding no.', 'finding', '#'],
                    discipline: ['discipline', 'disciplines'],
                    category: ['category', 'categories', 'cat'],
                    observationFinding: ['observation/finding', 'observation', 'finding', 'observations', 'findings', 'observation finding', 'description'],
                    impact: ['impact', 'impacts', 'consequence', 'consequences'],
                    recommendation: ['recommendation', 'recommendations', 'action', 'actions', 'corrective action'],
                    importance: ['importance', 'important', 'imp'],
                    urgency: ['urgency', 'urgent', 'urg'],
                    assignee: ['assignee', 'assigned to', 'assigned', 'responsible', 'owner', 'action party']
                };
                
                // Check each mapping rule
                for (const [columnType, variations] of Object.entries(mappingRules)) {
                    if (variations.some(variation => normalized.includes(variation))) {
                        return columnType;
                    }
                }
                
                return null;
            };
            
            return `
                <div class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-6">
                    <h4 class="font-medium mb-3">Preview & Column Mapping</h4>
                    
                    <div class="mb-4 overflow-x-auto">
                        <table class="w-full text-sm border-collapse">
                            <thead>
                                <tr>
                                    ${headers.map((header, index) => {
                                        const matchedColumn = matchColumn(header);
                                        return `
                                            <th class="border border-gray-300 dark:border-gray-600 p-2 bg-gray-50 dark:bg-gray-900">
                                                <div>${header}</div>
                                                <select id="col-map-${index}" 
                                                        onchange="app.project.updatePreviewColumnMapping(${index}, this.value)"
                                                        class="mt-1 w-full text-xs px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800">
                                                    <option value="">Unmapped</option>
                                                    <option value="findingNumber" ${matchedColumn === 'findingNumber' ? 'selected' : ''}>Finding #</option>
                                                    <option value="discipline" ${matchedColumn === 'discipline' ? 'selected' : ''}>Discipline</option>
                                                    <option value="category" ${matchedColumn === 'category' ? 'selected' : ''}>Category</option>
                                                    <option value="observationFinding" ${matchedColumn === 'observationFinding' ? 'selected' : ''}>Observation/Finding*</option>
                                                    <option value="impact" ${matchedColumn === 'impact' ? 'selected' : ''}>Impact</option>
                                                    <option value="recommendation" ${matchedColumn === 'recommendation' ? 'selected' : ''}>Recommendation</option>
                                                    <option value="importance" ${matchedColumn === 'importance' ? 'selected' : ''}>Importance</option>
                                                    <option value="urgency" ${matchedColumn === 'urgency' ? 'selected' : ''}>Urgency</option>
                                                    <option value="assignee" ${matchedColumn === 'assignee' ? 'selected' : ''}>Assignee</option>
                                                </select>
                                            </th>
                                        `;
                                    }).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${data.slice(0, 3).map(row => `
                                    <tr>
                                        ${row.map(cell => `<td class="border border-gray-300 dark:border-gray-600 p-2">${cell || ''}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${data.length > 3 ? `<p class="text-sm text-gray-600 dark:text-gray-400 mt-1">... and ${data.length - 3} more rows</p>` : ''}
                    </div>
                    
                    <button onclick="app.project.confirmImport('${project.id}')" 
                            class="mt-4 w-full py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                        <i class="fas fa-check mr-2"></i>Confirm Import
                    </button>
                </div>
            `;
        }

        // Project management methods
        createNewProject() {
            const name = prompt('Enter project name:');
            if (!name || !name.trim()) return;
            
            const project = new Project({ name: name.trim() });
            this.stateManager.addProject(project);
            this.selectProject(project.id);
        }

        selectProject(projectId) {
            this.stateManager.selectProject(projectId);
            app.renderManager.render();
        }

        editProjectName(projectId) {
            this.editingProjectId = projectId;
            app.renderManager.render();
            setTimeout(() => {
                const input = document.getElementById(`edit-project-${projectId}`);
                if (input) input.focus();
            }, 0);
        }

        saveProjectName(projectId) {
            const input = document.getElementById(`edit-project-${projectId}`);
            if (input && input.value.trim()) {
                this.stateManager.updateProject(projectId, { name: input.value.trim() });
            }
            this.editingProjectId = null;
            app.renderManager.render();
        }

        cancelProjectEdit() {
            this.editingProjectId = null;
            app.renderManager.render();
        }

        confirmDeleteProject(projectId) {
            if (confirm('Delete this project and all its actions?')) {
                this.stateManager.deleteProject(projectId);
                app.renderManager.render();
            }
        }

        processExcelImport() {
            const textarea = document.getElementById('excel-paste');
            const project = this.stateManager.state.projects.get(this.stateManager.state.selectedProjectId);
            
            if (!textarea || !textarea.value.trim() || !project) return;
            
            // Use PapaParse to parse TSV data
            const parseResult = Papa.parse(textarea.value.trim(), {
                delimiter: '\t',  // Tab-delimited
                header: false,    // We'll handle headers manually
                skipEmptyLines: true,
                quoteChar: '"',   // Handle quoted cells
                escapeChar: '"',  // Handle escaped quotes
                dynamicTyping: false  // Keep everything as strings
            });
            
            if (parseResult.errors.length > 0) {
                console.error('Parse errors:', parseResult.errors);
                alert('Error parsing data. Please check your Excel data and try again.');
                return;
            }
            
            const rows = parseResult.data;
            if (rows.length < 2) {
                alert('Please include at least a header row and one data row.');
                return;
            }
            
            project.excelHeaders = rows[0];
            project.tempExcelData = rows.slice(1);
            
            this.stateManager.updateProject(project.id, project);
            app.renderManager.render();
        }

        updatePreviewColumnMapping(colIndex, mappingType) {
            const project = this.stateManager.state.projects.get(this.stateManager.state.selectedProjectId);
            if (!project) return;
            
            const selects = document.querySelectorAll('select[id^="col-map-"]');
            selects.forEach(select => {
                const idx = parseInt(select.id.split('-')[2]);
                if (idx !== colIndex && select.value === mappingType) {
                    select.value = '';
                }
            });
        }

        confirmImport(projectId) {
            const project = this.stateManager.state.projects.get(projectId);
            if (!project) return;
            
            const selects = document.querySelectorAll('select[id^="col-map-"]');
            const mappings = {
                findingNumber: null,
                discipline: null,
                category: null,
                observationFinding: null,
                impact: null,
                recommendation: null,
                importance: null,
                urgency: null,
                assignee: null
            };
            
            selects.forEach(select => {
                const colIndex = parseInt(select.id.split('-')[2]);
                if (select.value) {
                    mappings[select.value] = colIndex;
                }
            });
            
            if (mappings.observationFinding === null) {
                alert('Please select at least an Observation/Finding column');
                return;
            }
            
            project.columnMapping = mappings;
            
            this.stateManager.updateProject(projectId, project);
            
            if (this.stateManager.state.replaceMode) {
                const existingActions = this.stateManager.getProjectActions(projectId);
                existingActions.forEach(action => {
                    this.stateManager.deleteAction(action.id);
                });
            }
            
            project.tempExcelData.forEach(row => {
                const observationText = row[mappings.observationFinding];
                if (!observationText) return;
                
                const action = new Action({
                    findingNumber: mappings.findingNumber !== null ? row[mappings.findingNumber] : '',
                    discipline: mappings.discipline !== null ? row[mappings.discipline] : '',
                    category: mappings.category !== null ? row[mappings.category] : '',
                    observationFinding: observationText,
                    impact: mappings.impact !== null ? row[mappings.impact] : '',
                    recommendation: mappings.recommendation !== null ? row[mappings.recommendation] : '',
                    importance: mappings.importance !== null ? row[mappings.importance] : '',
                    urgency: mappings.urgency !== null ? row[mappings.urgency] : '',
                    projectId: projectId,
                    assignee: mappings.assignee !== null ? row[mappings.assignee] || 'Unassigned' : 'Unassigned',
                    originalAssignee: mappings.assignee !== null ? row[mappings.assignee] || 'Unassigned' : 'Unassigned',
                    excelRowData: [...row]
                });
                
                this.stateManager.addAction(action);
            });
            
            project.tempExcelData = [];
            this.stateManager.updateProject(projectId, project);
            
            const textarea = document.getElementById('excel-paste');
            if (textarea) textarea.value = '';
            
            app.renderManager.render();
        }
    }

    // Table Editor
    class TableEditor {
        constructor(stateManager) {
            this.stateManager = stateManager;
            this.setupKeyboardShortcuts();
        }

        setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === 'z' && !e.shiftKey) {
                    e.preventDefault();
                    this.handleUndo();
                } else if ((e.metaKey || e.ctrlKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                    e.preventDefault();
                    this.handleRedo();
                }
            });
        }

        handleUndo() {
            if (this.stateManager.state.tableEditMode) {
                const state = this.stateManager.undoRedoManager.undo();
                if (state) {
                    this.stateManager.applyTableState(state);
                    this.stateManager.undoRedoManager.reset();
                    app.renderManager.render();
                }
            }
        }

        handleRedo() {
            if (this.stateManager.state.tableEditMode) {
                const state = this.stateManager.undoRedoManager.redo();
                if (state) {
                    this.stateManager.applyTableState(state);
                    this.stateManager.undoRedoManager.reset();
                    app.renderManager.render();
                }
            }
        }

        renderProjectDataTable(project) {
            const actions = this.stateManager.getProjectActions(project.id);
            const isEditMode = this.stateManager.state.tableEditMode;
            
            return `
                <div class="space-y-6">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden border border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center p-6 pb-4">
                            <h3 class="text-lg font-semibold">Imported Excel Data</h3>
                            <div class="flex gap-2">
                                <button onclick="app.tableEditor.addColumn()" 
                                        class="px-3 py-1 text-sm bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                                    <i class="fas fa-plus mr-1"></i>Add Column
                                </button>
                                <button onclick="app.tableEditor.toggleEditMode()" 
                                        class="px-3 py-1 text-sm ${isEditMode ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700'} text-white rounded-lg transition-colors">
                                    <i class="fas fa-${isEditMode ? 'check' : 'pen'} mr-1"></i>${isEditMode ? 'Save' : 'Edit'}
                                </button>
                                <button onclick="app.tableEditor.clearProjectData('${project.id}')" 
                                        class="px-3 py-1 text-sm bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                                    <i class="fas fa-trash mr-1"></i>Clear Data
                                </button>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm border-collapse" id="excel-table">
                                <thead>
                                    <tr class="border-t border-b border-gray-200 dark:border-gray-700">
                                        ${project.excelHeaders.map((header, index) => `
                                            <th class="text-left py-3 px-4 font-semibold border-r border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 relative">
                                                <div>${header}</div>
                                                <select id="column-mapping-${index}" 
                                                        name="column-mapping-${index}"
                                                        onchange="app.tableEditor.updateColumnMapping(${index}, this.value)" 
                                                        class="mt-1 text-xs px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800"
                                                        ${isEditMode ? 'disabled' : ''}>
                                                    <option value="">Unmapped</option>
                                                    <option value="findingNumber" ${project.columnMapping.findingNumber === index ? 'selected' : ''}>Finding #</option>
                                                    <option value="discipline" ${project.columnMapping.discipline === index ? 'selected' : ''}>Discipline</option>
                                                    <option value="category" ${project.columnMapping.category === index ? 'selected' : ''}>Category</option>
                                                    <option value="observationFinding" ${project.columnMapping.observationFinding === index ? 'selected' : ''}>Observation/Finding*</option>
                                                    <option value="impact" ${project.columnMapping.impact === index ? 'selected' : ''}>Impact</option>
                                                    <option value="recommendation" ${project.columnMapping.recommendation === index ? 'selected' : ''}>Recommendation</option>
                                                    <option value="importance" ${project.columnMapping.importance === index ? 'selected' : ''}>Importance</option>
                                                    <option value="urgency" ${project.columnMapping.urgency === index ? 'selected' : ''}>Urgency</option>
                                                    <option value="assignee" ${project.columnMapping.assignee === index ? 'selected' : ''}>Assignee</option>
                                                </select>
                                                ${this.getColumnIcon(project, index)}
                                                ${isEditMode ? `
                                                    <button onclick="app.tableEditor.deleteColumn(${index})" 
                                                            class="absolute top-2 right-2 text-red-600 hover:text-red-700 opacity-0 hover:opacity-100 transition-opacity">
                                                        <i class="fas fa-times text-xs"></i>
                                                    </button>
                                                ` : ''}
                                            </th>
                                        `).join('')}
                                        <th class="text-left py-3 px-4 font-semibold bg-gray-50 dark:bg-gray-900">
                                            Comment
                                            <div class="text-xs text-gray-500 dark:text-gray-400 font-normal mt-1">System</div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${actions.map((action, rowIndex) => `
                                        <tr class="border-b border-gray-200 dark:border-gray-700">
                                            ${action.excelRowData.map((cell, colIndex) => `
                                                <td class="py-3 px-4 border-r border-gray-200 dark:border-gray-700 ${
                                                    isEditMode ? 'cursor-text hover:bg-gray-50 dark:hover:bg-gray-700' : ''
                                                }" 
                                                    data-row="${rowIndex}" 
                                                    data-col="${colIndex}"
                                                    ${isEditMode ? `onclick="app.tableEditor.startCellEdit(${rowIndex}, ${colIndex}, '${action.id}')"` : ''}>
                                                    ${colIndex === project.columnMapping.observationFinding && !isEditMode ? `
                                                        <span class="cursor-pointer hover:text-blue-600 dark:hover:text-blue-400 transition-colors" 
                                                            onclick="app.selectActionForFocus('${action.id}')">
                                                            ${cell || ''}
                                                        </span>
                                                    ` : colIndex === project.columnMapping.assignee && !isEditMode && action.originalAssignee !== action.assignee && action.originalAssignee !== 'Unassigned' ? `
                                                        <div>
                                                            <span class="text-red-600 dark:text-red-400 line-through">${action.originalAssignee}</span>
                                                            <br>
                                                            <span class="text-green-600 dark:text-green-400">${action.assignee}</span>
                                                        </div>
                                                    ` : colIndex === project.columnMapping.assignee && !isEditMode && (!action.originalAssignee || action.originalAssignee === 'Unassigned') && action.assignee !== 'Unassigned' ? `
                                                        <span class="text-green-600 dark:text-green-400">${action.assignee}</span>
                                                    ` : isEditMode && this.stateManager.state.activeCell.row === rowIndex && this.stateManager.state.activeCell.col === colIndex ? `
                                                        <input type="text" 
                                                            id="active-cell-input"
                                                            name="active-cell-input"
                                                            value="${cell || ''}" 
                                                            onblur="app.tableEditor.saveCellEdit('${action.id}', ${colIndex}, this.value)"
                                                            onkeydown="app.tableEditor.handleCellKeydown(event, ${rowIndex}, ${colIndex}, '${action.id}')"
                                                            class="w-full px-1 py-0 border-0 bg-transparent focus:outline-none">
                                                    ` : cell || ''}
                                                </td>
                                            `).join('')}
                                            <td class="py-3 px-4">
                                                <span class="text-xs text-gray-600 dark:text-gray-400">${action.getAllComments()}</span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        getColumnIcon(project, index) {
            const mapping = Object.entries(project.columnMapping).find(([key, val]) => val === index);
            if (!mapping) return '';
            
            const icons = {
                findingNumber: '<i class="fas fa-hashtag text-gray-600 dark:text-gray-400 ml-2"></i>',
                discipline: '<i class="fas fa-graduation-cap text-purple-600 dark:text-purple-400 ml-2"></i>',
                category: '<i class="fas fa-tag text-indigo-600 dark:text-indigo-400 ml-2"></i>',
                observationFinding: '<i class="fas fa-eye text-blue-600 dark:text-blue-400 ml-2"></i>',
                impact: '<i class="fas fa-exclamation-triangle text-orange-600 dark:text-orange-400 ml-2"></i>',
                recommendation: '<i class="fas fa-lightbulb text-green-600 dark:text-green-400 ml-2"></i>',
                importance: '<i class="fas fa-exclamation-circle text-red-600 dark:text-red-400 ml-2"></i>',
                urgency: '<i class="fas fa-clock text-yellow-600 dark:text-yellow-400 ml-2"></i>',
                assignee: '<i class="fas fa-user text-teal-600 dark:text-teal-400 ml-2"></i>'
            };
            
            return icons[mapping[0]] || '';
        }

        toggleEditMode() {
            this.stateManager.state.tableEditMode = !this.stateManager.state.tableEditMode;
            this.stateManager.state.activeCell = { row: null, col: null };
            if (this.stateManager.state.tableEditMode) {
                this.stateManager.saveTableState();
            }
            app.renderManager.render();
        }

        startCellEdit(row, col, actionId) {
            this.stateManager.state.activeCell = { row, col };
            app.renderManager.render();
            setTimeout(() => {
                const input = document.getElementById('active-cell-input');
                if (input) {
                    input.focus();
                    input.setSelectionRange(input.value.length, input.value.length);
                }
            }, 0);
        }

        saveCellEdit(actionId, colIndex, value) {
            this.stateManager.saveTableState();
            const action = this.stateManager.state.actions.get(actionId);
            if (action && action.excelRowData[colIndex] !== undefined) {
                action.excelRowData[colIndex] = value;
                
                const project = this.stateManager.state.projects.get(action.projectId);
                if (project) {
                    if (colIndex === project.columnMapping.findingNumber) {
                        action.findingNumber = value;
                    } else if (colIndex === project.columnMapping.discipline) {
                        action.discipline = value;
                    } else if (colIndex === project.columnMapping.category) {
                        action.category = value;
                    } else if (colIndex === project.columnMapping.observationFinding) {
                        action.observationFinding = value;
                    } else if (colIndex === project.columnMapping.impact) {
                        action.impact = value;
                    } else if (colIndex === project.columnMapping.recommendation) {
                        action.recommendation = value;
                    } else if (colIndex === project.columnMapping.importance) {
                        action.importance = value;
                    } else if (colIndex === project.columnMapping.urgency) {
                        action.urgency = value;
                    } else if (colIndex === project.columnMapping.assignee) {
                        action.assignee = value || 'Unassigned';
                    }
                }
                
                this.stateManager.updateAction(actionId, action);
            }
            this.stateManager.state.activeCell = { row: null, col: null };
        }

        handleCellKeydown(event, row, col, actionId) {
            const table = document.getElementById('excel-table');
            const rows = table.querySelectorAll('tbody tr');
            const cols = rows[0]?.querySelectorAll('td');
            if (!cols) return;
            
            const maxRow = rows.length - 1;
            const maxCol = cols.length - 2;
            
            const actions = this.stateManager.getProjectActions(this.stateManager.state.selectedProjectId);
            const nextActionId = (r) => actions[r]?.id;
            
            switch(event.key) {
                case 'Enter':
                case 'ArrowDown':
                    event.preventDefault();
                    if (row < maxRow) {
                        this.saveCellEdit(actionId, col, event.target.value);
                        this.startCellEdit(row + 1, col, nextActionId(row + 1));
                    }
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    if (row > 0) {
                        this.saveCellEdit(actionId, col, event.target.value);
                        this.startCellEdit(row - 1, col, nextActionId(row - 1));
                    }
                    break;
                case 'ArrowRight':
                case 'Tab':
                    event.preventDefault();
                    if (col < maxCol) {
                        this.saveCellEdit(actionId, col, event.target.value);
                        this.startCellEdit(row, col + 1, actionId);
                    }
                    break;
                case 'ArrowLeft':
                    if (event.shiftKey && event.key === 'Tab' || event.key === 'ArrowLeft') {
                        event.preventDefault();
                        if (col > 0) {
                            this.saveCellEdit(actionId, col, event.target.value);
                            this.startCellEdit(row, col - 1, actionId);
                        }
                    }
                    break;
                case 'Escape':
                    event.preventDefault();
                    this.stateManager.state.activeCell = { row: null, col: null };
                    app.renderManager.render();
                    break;
            }
        }

        addColumn() {
            const project = this.stateManager.state.projects.get(this.stateManager.state.selectedProjectId);
            if (!project) return;
            
            const columnName = prompt('Enter column name:');
            if (!columnName || !columnName.trim()) return;
            
            project.excelHeaders.push(columnName.trim());
            project.customColumns.push(project.excelHeaders.length - 1);
            
            const actions = this.stateManager.getProjectActions(project.id);
            actions.forEach(action => {
                action.excelRowData.push('');
                this.stateManager.updateAction(action.id, action);
            });
            
            this.stateManager.updateProject(project.id, project);
            app.renderManager.render();
        }

        deleteColumn(index) {
            const project = this.stateManager.state.projects.get(this.stateManager.state.selectedProjectId);
            if (!project) return;
            
            if (confirm(`Delete column "${project.excelHeaders[index]}"?`)) {
                project.excelHeaders.splice(index, 1);
                
                Object.keys(project.columnMapping).forEach(key => {
                    if (project.columnMapping[key] === index) {
                        project.columnMapping[key] = null;
                    } else if (project.columnMapping[key] > index) {
                        project.columnMapping[key]--;
                    }
                });
                
                project.customColumns = project.customColumns.filter(col => col !== index).map(col => col > index ? col - 1 : col);
                
                const actions = this.stateManager.getProjectActions(project.id);
                actions.forEach(action => {
                    action.excelRowData.splice(index, 1);
                    this.stateManager.updateAction(action.id, action);
                });
                
                this.stateManager.updateProject(project.id, project);
                app.renderManager.render();
            }
        }

        updateColumnMapping(colIndex, mappingType) {
            const project = this.stateManager.state.projects.get(this.stateManager.state.selectedProjectId);
            if (!project) return;
            
            Object.keys(project.columnMapping).forEach(key => {
                if (project.columnMapping[key] === colIndex) {
                    project.columnMapping[key] = null;
                }
            });
            
            if (mappingType) {
                project.columnMapping[mappingType] = colIndex;
            }
            
            this.stateManager.updateProject(project.id, project);
            
            const actions = this.stateManager.getProjectActions(project.id);
            actions.forEach(action => {
                if (mappingType === 'findingNumber' && action.excelRowData[colIndex]) {
                    action.findingNumber = action.excelRowData[colIndex];
                } else if (mappingType === 'discipline' && action.excelRowData[colIndex]) {
                    action.discipline = action.excelRowData[colIndex];
                } else if (mappingType === 'category' && action.excelRowData[colIndex]) {
                    action.category = action.excelRowData[colIndex];
                } else if (mappingType === 'observationFinding' && action.excelRowData[colIndex]) {
                    action.observationFinding = action.excelRowData[colIndex];
                } else if (mappingType === 'impact' && action.excelRowData[colIndex]) {
                    action.impact = action.excelRowData[colIndex];
                } else if (mappingType === 'recommendation' && action.excelRowData[colIndex]) {
                    action.recommendation = action.excelRowData[colIndex];
                } else if (mappingType === 'importance' && action.excelRowData[colIndex]) {
                    action.importance = action.excelRowData[colIndex];
                } else if (mappingType === 'urgency' && action.excelRowData[colIndex]) {
                    action.urgency = action.excelRowData[colIndex];
                } else if (mappingType === 'assignee' && action.excelRowData[colIndex]) {
                    action.assignee = action.excelRowData[colIndex];
                }
                this.stateManager.updateAction(action.id, action);
            });
            
            app.renderManager.render();
        }

        clearProjectData(projectId) {
            if (confirm('Clear all imported data for this project?')) {
                const actions = this.stateManager.getProjectActions(projectId);
                actions.forEach(action => {
                    this.stateManager.deleteAction(action.id);
                });
                
                const project = this.stateManager.state.projects.get(projectId);
                if (project) {
                    project.excelHeaders = [];
                    project.tempExcelData = [];
                    project.columnMapping = {
                        findingNumber: null,
                        discipline: null,
                        category: null,
                        observationFinding: null,
                        impact: null,
                        recommendation: null,
                        importance: null,
                        urgency: null,
                        assignee: null
                    };
                    project.customColumns = [];
                    this.stateManager.updateProject(projectId, project);
                }
                
                app.renderManager.render();
            }
        }
    }

    // Focus Renderer
    class FocusRenderer {
        constructor(stateManager) {
            this.stateManager = stateManager;
            this.debouncedUpdateComment = debounce((actionId, value) => {
                this.stateManager.updateAction(actionId, { comment: value });
            }, 500);
        }

        render(container) {
            const action = this.stateManager.state.focusActionId ? 
                this.stateManager.state.actions.get(this.stateManager.state.focusActionId) : null;
            
            if (!action) {
                app.navigation.setView('overview');
                return;
            }
            
            const project = this.stateManager.state.projects.get(action.projectId);
            
            container.innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <div class="mb-6">
                        <button onclick="app.navigation.setView('overview')" class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors">
                            <i class="fas fa-arrow-left mr-2"></i>Back to Overview
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        ${this.renderHeaderSection(action, project)}
                        ${this.renderDetailsSection(action)}
                        ${this.renderEditableSection(action)}
                    </div>
                </div>
            `;
        }

        renderHeaderSection(action, project) {
            let header = '';
            if (action.discipline) header += action.discipline;
            if (action.discipline && action.category) header += ' - ';
            if (action.category) header += action.category;
            
            // Create a single-line preview of the observation/finding
            const observationPreview = action.observationFinding ? 
                (action.observationFinding.length > 100 ? 
                    action.observationFinding.substring(0, 100) + '...' : 
                    action.observationFinding) : '';
            
            const projectAssignees = this.stateManager.getProjectAssignees(action.projectId);
            const isEditingAssignee = this.stateManager.state.editingAssigneeId === action.id;
            
            return `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden border border-gray-200 dark:border-gray-700">
                    <div class="p-8 flex gap-6">
                        <!-- Left side - 60% -->
                        <div class="flex-1" style="flex: 0 0 60%;">
                            <h1 class="text-3xl font-bold mb-2">${header || 'Action Details'}</h1>
                            ${observationPreview ? `
                                <p class="text-gray-600 dark:text-gray-400 mb-4 line-clamp-1">${observationPreview}</p>
                            ` : ''}
                            <div class="flex items-center gap-6 text-sm text-gray-600 dark:text-gray-400">
                                ${action.findingNumber ? `
                                    <span class="flex items-center gap-2">
                                        <i class="fas fa-hashtag"></i>
                                        <span>Finding ${action.findingNumber}</span>
                                    </span>
                                ` : ''}
                                <span class="flex items-center gap-2">
                                    <i class="fas fa-folder"></i>
                                    <span>${project ? project.name : ''}</span>
                                </span>
                                <span class="flex items-center gap-2 relative">
                                    <i class="fas fa-user"></i>
                                    ${isEditingAssignee ? `
                                        <div class="relative">
                                            <input type="text" 
                                                id="assignee-input"
                                                name="assignee"
                                                value="${action.assignee}" 
                                                placeholder="Type to assign..." 
                                                class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-sm"
                                                oninput="app.focus.updateAssignee('${action.id}', this.value)"
                                                onkeypress="if(event.key === 'Enter') app.focus.hideAssigneeEdit('${action.id}')"
                                                onblur="app.focus.hideAssigneeEditDelayed('${action.id}')"
                                                onfocus="app.focus.showAssigneeSuggestions('${action.id}')"
                                                autocomplete="off">
                                            
                                            <!-- Suggestions dropdown -->
                                            <div id="assignee-suggestions" 
                                                class="absolute z-10 w-48 mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg hidden max-h-48 overflow-y-auto">
                                                ${projectAssignees.map(assignee => `
                                                    <div class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition-colors text-sm"
                                                        onmousedown="app.focus.selectAssignee('${action.id}', '${assignee}')">
                                                        ${assignee}
                                                    </div>
                                                `).join('')}
                                                ${projectAssignees.length === 0 ? `
                                                    <div class="px-4 py-2 text-gray-500 dark:text-gray-400 italic text-sm">
                                                        No existing assignees
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    ` : `
                                        <span class="cursor-pointer hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
                                            onclick="app.focus.showAssigneeEdit('${action.id}')">
                                            ${action.assignee}
                                        </span>
                                    `}
                                </span>
                                <span class="flex items-center gap-2">
                                    <i class="fas fa-clock"></i>
                                    <span>Modified ${new Date(action.lastModified).toLocaleDateString()}</span>
                                </span>
                            </div>
                            ${action.originalAssignee && action.originalAssignee !== action.assignee && action.originalAssignee !== 'Unassigned' ? `
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 ml-7">
                                    Originally: <span class="text-red-600 dark:text-red-400">${action.originalAssignee}</span>
                                </p>
                            ` : ''}
                        </div>
                        
                        <!-- Right side - 40% with padding -->
                        <div class="flex-none pl-4" style="flex: 0 0 40%;">
                            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
                                <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4 uppercase tracking-wider text-center">Priority Rating</h3>
                                <div class="flex gap-2 justify-center" id="star-rating-container" role="radiogroup" aria-label="Priority rating">
                                    ${[1, 2, 3, 4, 5].map(i => `
                                        <i class="fas fa-star text-2xl cursor-pointer transition-all duration-200 hover:scale-110 ${
                                            action.personalPriority >= i ? 'text-yellow-400' : 'text-gray-300'
                                        }" 
                                        role="radio"
                                        aria-checked="${action.personalPriority === i}"
                                        aria-label="${i} star${i > 1 ? 's' : ''}"
                                        tabindex="0"
                                        data-rating="${i}"
                                        onclick="app.focus.setStarRating(${i})"
                                        onkeypress="if(event.key === 'Enter' || event.key === ' ') app.focus.setStarRating(${i})"
                                        onmouseover="app.focus.hoverStarRating(${i})"
                                        onmouseout="app.focus.resetStarRating()"></i>
                                    `).join('')}
                                </div>
                                <p class="text-center mt-3 text-xs text-gray-600 dark:text-gray-400">
                                    ${action.personalPriority > 0 ? `Level: ${action.personalPriority}` : 'Set priority'}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        renderDetailsSection(action) {
            const importanceLevel = action.importance?.toUpperCase() || 'M';
            const urgencyLevel = action.urgency?.toUpperCase() || 'M';
            
            const importanceText = importanceLevel === 'H' ? 'High' : 
                                importanceLevel === 'L' ? 'Low' : 'Medium';
            const urgencyText = urgencyLevel === 'H' ? 'High' : 
                            urgencyLevel === 'L' ? 'Low' : 'Medium';
            
            const importanceColor = importanceLevel === 'H' ? '#DC2626' :
                                importanceLevel === 'L' ? '#10B981' : '#6B7280';
            const urgencyColor = urgencyLevel === 'H' ? '#DC2626' :
                                urgencyLevel === 'L' ? '#10B981' : '#6B7280';
            
            return `
                <div class="space-y-6">
                    ${action.observationFinding ? `
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                            <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4 uppercase tracking-wider">Observation/Finding</h3>
                            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
                                <p class="text-gray-700 dark:text-gray-300 mb-4">${action.observationFinding}</p>
                                <div class="flex items-center gap-6 text-sm">
                                    <span class="flex items-center gap-2">
                                        <span class="font-semibold text-gray-600 dark:text-gray-400">Importance:</span>
                                        <span class="inline-flex items-center gap-1">
                                            <span class="w-3 h-3 rounded-full" style="background-color: ${importanceColor}"></span>
                                            <span class="font-bold">${importanceText}</span>
                                        </span>
                                    </span>
                                    <span class="flex items-center gap-2">
                                        <span class="font-semibold text-gray-600 dark:text-gray-400">Urgency:</span>
                                        <span class="inline-flex items-center gap-1">
                                            <span class="w-3 h-3 rounded-full" style="background-color: ${urgencyColor}"></span>
                                            <span class="font-bold">${urgencyText}</span>
                                        </span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${action.impact ? `
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                            <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4 uppercase tracking-wider">Impact</h3>
                            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
                                <p class="text-gray-700 dark:text-gray-300">${action.impact}</p>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${action.recommendation ? `
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                            <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4 uppercase tracking-wider">Recommendation</h3>
                            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
                                <p class="text-gray-700 dark:text-gray-300">${action.recommendation}</p>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        renderEditableSection(action) {
            return `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-8 border border-gray-200 dark:border-gray-700">
                    <!-- Progress -->
                    <div class="mb-8">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Progress</h3>
                            <span class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="progress-value">${action.progress}%</span>
                        </div>
                        <input type="range" 
                            id="progress-slider"
                            name="progress"
                            min="0" 
                            max="100" 
                            value="${action.progress}" 
                            oninput="app.focus.updateProgress(this.value)"
                            class="w-full cursor-pointer"
                            aria-label="Progress percentage">
                        <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400 mt-2">
                            <span>Not Started</span>
                            <span>In Progress</span>
                            <span>Completed</span>
                        </div>
                    </div>
                    
                    <!-- Comment -->
                    <div class="mb-8">
                        <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4 uppercase tracking-wider">Comment</h3>
                        <div class="relative">
                            <label for="comment-input" class="sr-only">Comment</label>
                            <textarea id="comment-input" 
                                    name="comment"
                                    placeholder="Add a comment..." 
                                    class="w-full px-4 py-3 pr-12 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all resize-none"
                                    rows="3"
                                    oninput="app.focus.updateComment('${action.id}', this.value)">${action.comment || ''}</textarea>
                            <i class="fas fa-comment-dots absolute right-4 top-3.5 text-gray-400"></i>
                        </div>
                    </div>
                    
                    <!-- Task List -->
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4 uppercase tracking-wider">Task List</h3>
                        <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
                            <div class="space-y-2 mb-4">
                                ${action.taskList.map((task, index) => `
                                    <div class="group flex items-center gap-3 p-3 rounded-lg bg-white dark:bg-gray-800 shadow-sm hover:shadow-md transition-all border border-gray-200 dark:border-gray-700">
                                        <input type="checkbox" 
                                            id="task-${index}"
                                            name="task-${index}"
                                            ${task.completed ? 'checked' : ''} 
                                            onchange="app.focus.toggleTask(${index})"
                                            class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 cursor-pointer"
                                            aria-label="Task checkbox">
                                        <label for="task-input-${index}" class="sr-only">Task text</label>
                                        <input type="text" 
                                            id="task-input-${index}"
                                            name="task-input-${index}"
                                            value="${task.text}" 
                                            onchange="app.focus.updateTaskText(${index}, this.value)"
                                            class="flex-1 bg-transparent border-0 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1 ${task.completed ? 'line-through text-gray-500' : 'text-gray-700 dark:text-gray-300'}">
                                        <button onclick="app.focus.deleteTask(${index})" 
                                                class="text-red-600 hover:text-red-700 opacity-0 group-hover:opacity-100 transition-opacity focus:opacity-100 p-2"
                                                aria-label="Delete task">
                                            <i class="fas fa-trash text-sm"></i>
                                        </button>
                                    </div>
                                `).join('')}
                                ${action.taskList.length === 0 ? `
                                    <p class="text-sm text-gray-500 dark:text-gray-400 italic text-center py-4">No tasks yet</p>
                                ` : ''}
                            </div>
                            <div class="relative">
                                <label for="new-task" class="sr-only">New task</label>
                                <input type="text" 
                                    id="new-task" 
                                    name="new-task"
                                    placeholder="Add a new task..." 
                                    class="w-full px-4 py-3 pr-12 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                    onkeypress="if(event.key === 'Enter') app.focus.addTask()">
                                <button onclick="app.focus.addTask()" 
                                        class="absolute right-2 top-2 px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors"
                                        aria-label="Add task">
                                    <i class="fas fa-plus text-sm"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Assignee editing methods
        showAssigneeEdit(actionId) {
            this.stateManager.state.editingAssigneeId = actionId;
            app.renderManager.render();
            // Focus on input after render
            setTimeout(() => {
                const input = document.getElementById('assignee-input');
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 0);
        }

        hideAssigneeEdit(actionId) {
            this.stateManager.state.editingAssigneeId = null;
            app.renderManager.render();
        }

        hideAssigneeEditDelayed(actionId) {
            // Delay to allow clicking on suggestions
            setTimeout(() => {
                if (this.stateManager.state.editingAssigneeId === actionId) {
                    this.hideAssigneeEdit(actionId);
                }
            }, 200);
        }

        updateAssignee(actionId, value) {
            const action = this.stateManager.state.actions.get(actionId);
            if (!action) return;
            
            // Update assignee immediately on every input change
            this.stateManager.updateAction(actionId, { assignee: value });
            
            // Filter suggestions based on input
            const projectAssignees = this.stateManager.getProjectAssignees(action.projectId);
            const suggestions = document.getElementById('assignee-suggestions');
            if (suggestions) {
                const filtered = projectAssignees.filter(assignee => 
                    assignee.toLowerCase().includes(value.toLowerCase())
                );
                
                if (filtered.length > 0 && value.trim()) {
                    suggestions.innerHTML = filtered.map(assignee => `
                        <div class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition-colors text-sm"
                            onmousedown="app.focus.selectAssignee('${actionId}', '${assignee}')">
                            ${assignee}
                        </div>
                    `).join('');
                } else if (value.trim()) {
                    suggestions.innerHTML = `
                        <div class="px-4 py-2 text-gray-500 dark:text-gray-400 italic text-sm">
                            New assignee: "${value}"
                        </div>
                    `;
                } else {
                    // Show all assignees if input is empty
                    suggestions.innerHTML = projectAssignees.map(assignee => `
                        <div class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition-colors text-sm"
                            onmousedown="app.focus.selectAssignee('${actionId}', '${assignee}')">
                            ${assignee}
                        </div>
                    `).join('') || `
                        <div class="px-4 py-2 text-gray-500 dark:text-gray-400 italic text-sm">
                            No existing assignees in this project
                        </div>
                    `;
                }
            }
        }

        showAssigneeSuggestions(actionId) {
            const suggestions = document.getElementById('assignee-suggestions');
            if (suggestions) {
                suggestions.classList.remove('hidden');
            }
        }

        hideAssigneeSuggestions() {
            // Small delay to allow clicking on suggestions
            setTimeout(() => {
                const suggestions = document.getElementById('assignee-suggestions');
                if (suggestions) {
                    suggestions.classList.add('hidden');
                }
            }, 200);
        }

        selectAssignee(actionId, assignee) {
            const input = document.getElementById('assignee-input');
            if (input) {
                input.value = assignee;
            }
            this.stateManager.updateAction(actionId, { assignee });
            this.hideAssigneeSuggestions();
        }

        // Star rating methods
        setStarRating(rating) {
            const actionId = this.stateManager.state.focusActionId;
            if (!actionId) return;
            
            this.stateManager.updateAction(actionId, { personalPriority: rating });
            this.updateStarDisplay(rating);
        }

        hoverStarRating(rating) {
            const stars = document.querySelectorAll('#star-rating-container i');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('text-yellow-300');
                } else {
                    star.classList.remove('text-yellow-300');
                }
            });
        }

        resetStarRating() {
            const action = this.stateManager.state.actions.get(this.stateManager.state.focusActionId);
            if (action) {
                this.updateStarDisplay(action.personalPriority || 0);
            }
        }

        updateStarDisplay(rating) {
            const stars = document.querySelectorAll('#star-rating-container i');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('text-yellow-400');
                    star.classList.remove('text-gray-300');
                } else {
                    star.classList.remove('text-yellow-400');
                    star.classList.add('text-gray-300');
                }
                star.classList.remove('text-yellow-300');
            });
        }

        // Progress method
        updateProgress(value) {
            const actionId = this.stateManager.state.focusActionId;
            if (!actionId) return;
            
            this.stateManager.updateAction(actionId, { progress: parseInt(value) });
            const progressValue = document.getElementById('progress-value');
            if (progressValue) progressValue.textContent = value + '%';
        }

        // Comment method
        updateComment(actionId, value) {
            this.debouncedUpdateComment(actionId, value);
        }

        // Task methods
        addTask() {
            const actionId = this.stateManager.state.focusActionId;
            const input = document.getElementById('new-task');
            if (!actionId || !input || !input.value.trim()) return;
            
            const action = this.stateManager.state.actions.get(actionId);
            if (!action) return;
            
            action.taskList.push({
                id: generateId(),
                text: input.value.trim(),
                completed: false
            });
            
            this.stateManager.updateAction(actionId, { taskList: action.taskList });
            app.renderManager.render();
        }

        toggleTask(index) {
            const actionId = this.stateManager.state.focusActionId;
            const action = this.stateManager.state.actions.get(actionId);
            if (!action || !action.taskList[index]) return;
            
            action.taskList[index].completed = !action.taskList[index].completed;
            this.stateManager.updateAction(actionId, { taskList: action.taskList });
            app.renderManager.render();
        }

        updateTaskText(index, text) {
            const actionId = this.stateManager.state.focusActionId;
            const action = this.stateManager.state.actions.get(actionId);
            if (!action || !action.taskList[index]) return;
            
            action.taskList[index].text = text;
            this.stateManager.updateAction(actionId, { taskList: action.taskList });
        }

        deleteTask(index) {
            const actionId = this.stateManager.state.focusActionId;
            const action = this.stateManager.state.actions.get(actionId);
            if (!action) return;
            
            action.taskList.splice(index, 1);
            this.stateManager.updateAction(actionId, { taskList: action.taskList });
            app.renderManager.render();
        }
    }

    // Import/Export Renderer
    class ImportExportRenderer {
        constructor(stateManager) {
            this.stateManager = stateManager;
            this.mode = 'export'; // 'export' or 'import'
        }

        render(container) {
            const projects = Array.from(this.stateManager.state.projects.values());
            
            container.innerHTML = `
                <div class="mb-8">
                    <h2 class="text-2xl font-bold mb-2">Import/Export Database</h2>
                    <p class="text-gray-600 dark:text-gray-400">Manage your database files</p>
                </div>
                
                <div class="max-w-2xl mx-auto">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                        ${this.mode === 'export' ? this.renderExportView(projects) : this.renderImportView()}
                    </div>
                </div>
                
                <!-- Hidden file input -->
                <input type="file" 
                       id="import-file-hidden" 
                       name="import-file"
                       accept=".json" 
                       style="display: none;"
                       onchange="app.importExport.handleFileSelect(event)">
            `;
        }

        renderExportView(projects) {
            return `
                <div>
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold">
                            <i class="fas fa-download text-blue-600 mr-2"></i>
                            Export Database
                        </h3>
                        <button onclick="app.importExport.openFileDialog()" 
                                class="px-4 py-2 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-colors border border-gray-300 dark:border-gray-600">
                            <i class="fas fa-upload mr-2"></i>Import File
                        </button>
                    </div>
                    
                    <div class="mb-6">
                        <label for="export-filename" class="block text-sm font-medium mb-2">Filename</label>
                        <input type="text" 
                               id="export-filename" 
                               name="export-filename"
                               value="action-tracker-${new Date().toISOString().split('T')[0]}.json"
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-2">Select Projects to Export</label>
                        ${projects.length > 0 ? `
                            <fieldset>
                                <legend class="sr-only">Select projects to export</legend>
                                <div class="space-y-2 max-h-64 overflow-y-auto border border-gray-300 dark:border-gray-600 rounded-lg p-4">
                                    ${projects.map((project, index) => `
                                        <label class="flex items-center p-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">
                                            <input type="checkbox" 
                                                   id="export-project-${project.id}"
                                                   name="export-projects"
                                                   value="${project.id}" 
                                                   checked 
                                                   class="mr-3 export-project-checkbox">
                                            <span class="flex-1">${project.name}</span>
                                            <span class="text-sm text-gray-500 dark:text-gray-400">${this.stateManager.getProjectActions(project.id).length} actions</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </fieldset>
                        ` : `
                            <div class="text-center py-12 border border-gray-300 dark:border-gray-600 rounded-lg">
                                <i class="fas fa-inbox text-4xl text-gray-400 mb-4"></i>
                                <p class="text-gray-500 dark:text-gray-400">
                                    No projects to export. Create projects and add actions first.
                                </p>
                            </div>
                        `}
                    </div>
                    
                    <button onclick="app.importExport.exportDatabase()" 
                            class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium ${projects.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${projects.length === 0 ? 'disabled' : ''}>
                        <i class="fas fa-download mr-2"></i>Export Selected Projects
                    </button>
                </div>
            `;
        }

        renderImportView() {
            return `
                <div>
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold">
                            <i class="fas fa-upload text-green-600 mr-2"></i>
                            Import Database
                        </h3>
                        <button onclick="app.importExport.switchToExport()" 
                                class="px-4 py-2 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-colors border border-gray-300 dark:border-gray-600">
                            <i class="fas fa-times mr-2"></i>Cancel Import
                        </button>
                    </div>
                    
                    <div class="mb-6">
                        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6">
                            <p class="text-sm text-blue-800 dark:text-blue-300">
                                <i class="fas fa-info-circle mr-2"></i>
                                Import a previously exported database file. This will add new projects and actions to your current database.
                            </p>
                        </div>
                        
                        <label for="import-file" class="block text-sm font-medium mb-2">Select Database File</label>
                        <input type="file" 
                               id="import-file" 
                               name="import-file"
                               accept=".json" 
                               onchange="app.importExport.handleFileSelect(event)"
                               class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-gray-700 dark:file:text-gray-300"
                               aria-describedby="import-file-help">
                        <p id="import-file-help" class="sr-only">Select a JSON file that was previously exported from Task Worker</p>
                        
                        <div id="file-preview" class="mt-4"></div>
                    </div>
                    
                    <button onclick="app.importExport.importDatabase()" 
                            id="import-button"
                            class="w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-medium opacity-50 cursor-not-allowed"
                            disabled>
                        <i class="fas fa-upload mr-2"></i>Import Database
                    </button>
                </div>
            `;
        }

        openFileDialog() {
            const fileInput = document.getElementById('import-file-hidden');
            if (fileInput) {
                fileInput.click();
            }
        }

        switchToImport() {
            this.mode = 'import';
            app.renderManager.render();
        }

        switchToExport() {
            this.mode = 'export';
            app.renderManager.render();
        }

        handleFileSelect(event) {
            if (this.mode === 'export') {
                this.switchToImport();
            }
            
            const file = event.target.files[0];
            const preview = document.getElementById('file-preview');
            const importButton = document.getElementById('import-button');
            
            if (file) {
                preview.innerHTML = `
                    <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-medium">${file.name}</p>
                                <p class="text-sm text-gray-500">Size: ${(file.size / 1024).toFixed(2)} KB</p>
                            </div>
                            <i class="fas fa-file-code text-2xl text-gray-400"></i>
                        </div>
                    </div>
                `;
                importButton.disabled = false;
                importButton.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                preview.innerHTML = '';
                importButton.disabled = true;
                importButton.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        exportDatabase() {
            const checkboxes = document.querySelectorAll('.export-project-checkbox:checked');
            const projectIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (projectIds.length === 0) {
                alert('Please select at least one project to export');
                return;
            }
            
            const filename = document.getElementById('export-filename').value || 'action-tracker-export.json';
            const data = this.stateManager.exportDatabase(projectIds);
            
            downloadJSON(data, filename);
        }

        importDatabase() {
            const fileInput = document.getElementById('import-file') || document.getElementById('import-file-hidden');
            if (!fileInput || !fileInput.files[0]) {
                alert('Please select a file to import');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    this.stateManager.importDatabase(data);
                    alert('Import completed successfully!');
                    this.switchToExport();
                    app.renderManager.render();
                } catch (error) {
                    alert('Invalid file format');
                }
            };
            reader.readAsText(fileInput.files[0]);
        }
    }

    // Render Manager
    class RenderManager {
        constructor(stateManager) {
            this.stateManager = stateManager;
            this.overview = new OverviewRenderer(stateManager, null);
            this.project = new ProjectRenderer(stateManager);
            this.focus = new FocusRenderer(stateManager);
            this.importExport = new ImportExportRenderer(stateManager);
        }

        render() {
            const view = this.stateManager.state.currentView;
            const content = document.getElementById('main-content');
            
            switch(view) {
                case 'overview':
                    this.overview.render(content);
                    break;
                case 'projects':
                    this.project.render(content);
                    break;
                case 'focus':
                    this.focus.render(content);
                    break;
                case 'import-export':
                    this.importExport.render(content);
                    break;
            }
        }
    }

    // Main App Controller
    class App {
        constructor() {
            this.stateManager = new StateManager();
            this.renderManager = new RenderManager(this.stateManager);
            this.navigation = new NavigationManager(this.stateManager, this.renderManager);
            this.filter = new FilterManager(this.stateManager, this.renderManager);
            this.tableEditor = new TableEditor(this.stateManager);
            
            // Set filter manager reference for overview renderer
            this.renderManager.overview.filterManager = this.filter;
            
            // Expose renderer instances
            this.project = this.renderManager.project;
            this.focus = this.renderManager.focus;
            this.importExport = this.renderManager.importExport;
        }

        init() {
            this.stateManager.init();
            this.navigation.updateNavHighlight(this.stateManager.state.currentView);
            this.renderManager.render();
        }

        // Helper methods for global access
        toggleDarkMode() {
            this.stateManager.toggleDarkMode();
        }

        selectActionForFocus(actionId) {
            this.stateManager.setFocusAction(actionId);
            this.navigation.setView('focus');
        }

        toggleCardExpansion(actionId) {
            this.stateManager.toggleCardExpansion(actionId);
            this.renderManager.render();
        }

        clickProgressBar(actionId) {
            const action = this.stateManager.state.actions.get(actionId);
            if (action) {
                this.stateManager.toggleProgressFilter(action);
                this.renderManager.render();
            }
        }

        clickStarFilter() {
            this.stateManager.toggleRatingFilter();
            this.renderManager.render();
        }

        clickPriorityFilter(priorityLevel) {
            this.stateManager.togglePriorityLevelFilter(priorityLevel);
            this.renderManager.render();
        }
    }

    // Initialize App
    const app = new App();
    app.init();
    </script>
</body>
</html>
